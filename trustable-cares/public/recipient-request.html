<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Request Blood - Trustable Cares</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#e74c3c',
            secondary: '#3498db',
            dark: '#2c3e50',
            light: '#ecf0f1',
            success: '#2ecc71',
            warning: '#f39c12',
            danger: '#c0392b'
          },
          fontFamily: {
            sans: ['Poppins', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="font-sans bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <nav class="flex justify-between items-center py-4">
        <a href="/" class="text-2xl font-bold text-primary">
          <i class="fas fa-heartbeat mr-2"></i>Trustable Cares
        </a>
        
        <div class="hidden md:flex items-center space-x-6">
          <a href="/" class="font-medium hover:text-primary transition-colors">Home</a>
          <a href="/about.html" class="font-medium hover:text-primary transition-colors">About</a>
          <a href="/contact.html" class="font-medium hover:text-primary transition-colors">Contact</a>
          <a href="/faq.html" class="font-medium hover:text-primary transition-colors">FAQ</a>
          <div class="relative group">
            <button class="flex items-center space-x-1 font-medium">
              <span>My Account</span>
              <i class="fas fa-chevron-down text-sm"></i>
            </button>
            <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block">
              <a href="/recipients/dashboard" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
              <a href="/recipients/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="/recipients/request" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Request Blood</a>
              <div class="border-t border-gray-100"></div>
              <a href="/recipients/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
            </div>
          </div>
        </div>
        
        <button class="md:hidden text-dark text-xl">
          <i class="fas fa-bars"></i>
        </button>
      </nav>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div class="md:hidden bg-white shadow-md hidden" id="mobile-menu">
    <div class="container mx-auto px-4 py-3">
      <a href="/" class="block py-2 font-medium hover:text-primary transition-colors">Home</a>
      <a href="/about.html" class="block py-2 font-medium hover:text-primary transition-colors">About</a>
      <a href="/contact.html" class="block py-2 font-medium hover:text-primary transition-colors">Contact</a>
      <a href="/faq.html" class="block py-2 font-medium hover:text-primary transition-colors">FAQ</a>
      <div class="border-t border-gray-200 my-2"></div>
      <a href="/recipients/dashboard" class="block py-2 font-medium hover:text-primary transition-colors">Dashboard</a>
      <a href="/recipients/profile" class="block py-2 font-medium hover:text-primary transition-colors">Profile</a>
      <a href="/recipients/request" class="block py-2 font-medium hover:text-primary transition-colors">Request Blood</a>
      <a href="/recipients/logout" class="block py-2 font-medium hover:text-primary transition-colors">Logout</a>
    </div>
  </div>

  <!-- Page Header -->
  <section class="bg-secondary text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-3xl md:text-4xl font-bold mb-4">Request Blood</h1>
      <p class="max-w-2xl mx-auto">Fill out the form below to create a new blood request. We'll help you find matching donors in your area.</p>
    </div>
  </section>

  <!-- Dashboard -->
  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <div class="w-full md:w-64 bg-white rounded-lg shadow-md p-6 mb-6 md:mb-0 md:mr-6">
        <div class="text-center mb-6">
          <div class="w-24 h-24 rounded-full bg-secondary text-white flex items-center justify-center text-3xl font-bold mx-auto mb-4" id="recipient-avatar">
            RS
          </div>
          <h2 class="text-xl font-bold" id="recipient-name">Rahul Sharma</h2>
          <p class="text-gray-600" id="recipient-blood-group">B+ Blood Group</p>
        </div>
        
        <ul class="space-y-2">
          <li>
            <a href="/recipients/dashboard" class="flex items-center space-x-2 text-gray-700 hover:text-secondary p-2 rounded-md hover:bg-blue-50 transition-colors">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="/recipients/profile" class="flex items-center space-x-2 text-gray-700 hover:text-secondary p-2 rounded-md hover:bg-blue-50 transition-colors">
              <i class="fas fa-user"></i>
              <span>Profile</span>
            </a>
          </li>
          <li>
            <a href="/recipients/request" class="flex items-center space-x-2 text-secondary font-medium p-2 rounded-md bg-blue-50">
              <i class="fas fa-tint"></i>
              <span>Request Blood</span>
            </a>
          </li>
          <li>
            <a href="/recipients/notifications" class="flex items-center space-x-2 text-gray-700 hover:text-secondary p-2 rounded-md hover:bg-blue-50 transition-colors">
              <i class="fas fa-bell"></i>
              <span>Notifications</span>
              <span class="ml-auto bg-secondary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
            </a>
          </li>
          <li class="border-t border-gray-200 my-2 pt-2">
            <a href="/recipients/logout" class="flex items-center space-x-2 text-gray-700 hover:text-secondary p-2 rounded-md hover:bg-blue-50 transition-colors">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Main Content -->
      <div class="flex-1">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h1 class="text-2xl font-bold mb-4">Create Blood Request</h1>
          <p class="text-gray-600 mb-6">Please fill out the form below to create a new blood request. We'll match you with compatible donors in your area.</p>
          
          <form id="blood-request-form">
            <!-- Request Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-200">Request Information</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="bloodGroup" class="block mb-2 font-medium">Blood Group <span class="text-red-500">*</span></label>
                  <select id="bloodGroup" name="bloodGroup" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required disabled>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                  <p class="text-sm text-gray-500 mt-1">This is your registered blood group.</p>
                </div>
                
                <div class="form-group">
                  <label for="unitsRequired" class="block mb-2 font-medium">Units Required <span class="text-red-500">*</span></label>
                  <input type="number" id="unitsRequired" name="unitsRequired" min="1" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
                
                <div class="form-group">
                  <label for="urgency" class="block mb-2 font-medium">Urgency Level <span class="text-red-500">*</span></label>
                  <select id="urgency" name="urgency" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="requiredBy" class="block mb-2 font-medium">Required By <span class="text-red-500">*</span></label>
                  <input type="date" id="requiredBy" name="requiredBy" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
              </div>
            </div>
            
            <!-- Hospital Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-200">Hospital Information</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group md:col-span-2">
                  <label for="hospital" class="block mb-2 font-medium">Hospital Name <span class="text-red-500">*</span></label>
                  <input type="text" id="hospital" name="hospital" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
                
                <div class="form-group md:col-span-2">
                  <label for="hospitalAddress" class="block mb-2 font-medium">Hospital Address <span class="text-red-500">*</span></label>
                  <input type="text" id="hospitalAddress" name="hospitalAddress" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
                
                <div class="form-group">
                  <label for="hospitalCity" class="block mb-2 font-medium">City <span class="text-red-500">*</span></label>
                  <input type="text" id="hospitalCity" name="hospitalCity" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
                
                <div class="form-group">
                  <label for="hospitalPinCode" class="block mb-2 font-medium">PIN Code <span class="text-red-500">*</span></label>
                  <input type="text" id="hospitalPinCode" name="hospitalPinCode" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary" required>
                </div>
              </div>
            </div>
            
            <!-- Additional Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-200">Additional Information</h3>
              
              <div class="form-group">
                <label for="purpose" class="block mb-2 font-medium">Purpose</label>
                <textarea id="purpose" name="purpose" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary"></textarea>
                <p class="text-sm text-gray-500 mt-1">Please provide details about why the blood is needed (e.g., surgery, accident, etc.)</p>
              </div>
              
              <div class="form-group mt-4">
                <label for="notes" class="block mb-2 font-medium">Additional Notes</label>
                <textarea id="notes" name="notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-secondary"></textarea>
                <p class="text-sm text-gray-500 mt-1">Any additional information that might be helpful for donors.</p>
              </div>
            </div>
            
            <!-- Submit Button -->
            <div class="text-center">
              <button type="submit" class="bg-secondary text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">Submit Blood Request</button>
            </div>
          </form>
        </div>
        
        <!-- Matching Donors -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="matching-donors">
          <!-- This section will be populated with matching donors after form submission -->
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white py-8 mt-12">
    <div class="container mx-auto px-4">
      <div class="text-center">
        <p>&copy; 2023 Trustable Cares. All rights reserved.</p>
        <div class="flex justify-center space-x-4 mt-4">
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fab fa-twitter"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fab fa-instagram"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <i class="fab fa-linkedin-in"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="/js/main.js"></script>
  <script>
    // Mobile menu toggle
    const menuButton = document.querySelector('button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    menuButton.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
    
    // Fetch recipient data
    async function fetchRecipientData() {
      try {
        const response = await fetch('/api/recipients/profile');
        const data = await response.json();
        
        if (data.success) {
          const recipient = data.recipient;
          
          // Update profile information
          document.getElementById('recipient-name').textContent = recipient.name;
          document.getElementById('recipient-blood-group').textContent = `${recipient.bloodGroup} Blood Group`;
          
          // Set avatar initials
          const nameParts = recipient.name.split(' ');
          const initials = nameParts.length > 1 
            ? `${nameParts[0][0]}${nameParts[1][0]}`
            : nameParts[0].substring(0, 2);
          document.getElementById('recipient-avatar').textContent = initials.toUpperCase();
          
          // Set blood group in form
          const bloodGroupSelect = document.getElementById('bloodGroup');
          for (let i = 0; i < bloodGroupSelect.options.length; i++) {
            if (bloodGroupSelect.options[i].value === recipient.bloodGroup) {
              bloodGroupSelect.selectedIndex = i;
              break;
            }
          }
          
          // Set default required by date (7 days from now)
          const requiredByInput = document.getElementById('requiredBy');
          const defaultDate = new Date();
          defaultDate.setDate(defaultDate.getDate() + 7);
          requiredByInput.valueAsDate = defaultDate;
          
          // Set hospital information if available
          if (recipient.hospital) {
            document.getElementById('hospital').value = recipient.hospital;
          }
        }
      } catch (error) {
        console.error('Error fetching recipient data:', error);
      }
    }
    
    // Form submission
    const bloodRequestForm = document.getElementById('blood-request-form');
    
    bloodRequestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Basic form validation
      const bloodGroup = document.getElementById('bloodGroup').value;
      const unitsRequired = document.getElementById('unitsRequired').value;
      const urgency = document.getElementById('urgency').value;
      const requiredBy = document.getElementById('requiredBy').value;
      const hospital = document.getElementById('hospital').value;
      const hospitalAddress = document.getElementById('hospitalAddress').value;
      const hospitalCity = document.getElementById('hospitalCity').value;
      const hospitalPinCode = document.getElementById('hospitalPinCode').value;
      
      if (!bloodGroup || !unitsRequired || !urgency || !requiredBy || !hospital || !hospitalAddress || !hospitalCity || !hospitalPinCode) {
        alert('Please fill in all required fields.');
        return;
      }
      
      // Create request data object
      const requestData = {
        bloodGroup,
        unitsRequired,
        urgency,
        requiredBy,
        hospital,
        hospitalAddress,
        hospitalCity,
        hospitalPinCode,
        purpose: document.getElementById('purpose').value,
        notes: document.getElementById('notes').value
      };
      
      try {
        // Send data to server
        const response = await fetch('/recipients/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show success message
          const matchingDonorsContainer = document.getElementById('matching-donors');
          matchingDonorsContainer.innerHTML = `
            <div class="mb-4">
              <div class="bg-green-100 border border-green-200 text-green-800 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                  <i class="fas fa-check-circle text-green-500 text-xl mr-2"></i>
                  <div>
                    <h3 class="font-semibold">Blood Request Created Successfully!</h3>
                    <p>Your request has been submitted and we've found ${data.matchCount} matching donors in your area.</p>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Scroll to matching donors section
          matchingDonorsContainer.scrollIntoView({ behavior: 'smooth' });
          
          // Show matching donors if available
          if (data.matchingDonors && data.matchingDonors.length > 0) {
            const donorsGrid = document.createElement('div');
            donorsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            
            data.matchingDonors.forEach(donor => {
              const donorCard = document.createElement('div');
              donorCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
              
              const nameParts = donor.name.split(' ');
              const initials = nameParts.length > 1 
                ? `${nameParts[0][0]}${nameParts[1][0]}`
                : nameParts[0].substring(0, 2);
              
              let lastDonation = 'Never donated';
              if (donor.lastDonationDate) {
                const lastDonationDate = new Date(donor.lastDonationDate);
                const now = new Date();
                const diffTime = Math.abs(now - lastDonationDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 30) {
                  lastDonation = `${diffDays} days ago`;
                } else if (diffDays < 365) {
                  const diffMonths = Math.floor(diffDays / 30);
                  lastDonation = `${diffMonths} month${diffMonths > 1 ? 's' : ''} ago`;
                } else {
                  const diffYears = Math.floor(diffDays / 365);
                  lastDonation = `${diffYears} year${diffYears > 1 ? 's' : ''} ago`;
                }
              }
              
              donorCard.innerHTML = `
                <div class="flex items-start">
                  <div class="bg-primary text-white rounded-full w-12 h-12 flex items-center justify-center text-xl font-bold mr-4">
                    ${initials.toUpperCase()}
                  </div>
                  <div>
                    <h3 class="font-semibold text-lg">${donor.name}</h3>
                    <p class="text-gray-600">${donor.bloodGroup} Blood Group</p>
                    <p class="text-gray-600">${donor.city}, ${donor.pinCode}</p>
                    <p class="text-gray-600">Last Donation: ${lastDonation}</p>
                    <div class="mt-2">
                      <a href="tel:${donor.phone}" class="inline-flex items-center text-primary hover:text-red-700">
                        <i class="fas fa-phone-alt mr-1"></i> Contact
                      </a>
                    </div>
                  </div>
                </div>
              `;
              
              donorsGrid.appendChild(donorCard);
            });
            
            matchingDonorsContainer.appendChild(donorsGrid);
          } else {
            matchingDonorsContainer.innerHTML += `
              <div class="text-center py-8">
                <div class="text-gray-400 text-5xl mb-4">
                  <i class="fas fa-user-slash"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">No Matching Donors Found</h3>
                <p class="text-gray-600 mb-4">We couldn't find any matching donors in your area at the moment. We'll notify you when a donor becomes available.</p>
              </div>
            `;
          }
          
          // Reset form
          bloodRequestForm.reset();
          
          // Set blood group again (since it was reset)
          fetchRecipientData();
        } else {
          alert(data.error || 'Request creation failed. Please try again.');
        }
      } catch (error) {
        alert('An error occurred. Please try again later.');
        console.error(error);
      }
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      fetchRecipientData();
    });
  </script>
</body>
</html>
